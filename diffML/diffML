#!/usr/bin/python3

from PyQt5.QtWidgets import QApplication, QGridLayout, QWidget, QFileDialog, QPushButton
from PyQt5.QtWidgets import QInputDialog, QMainWindow, QMessageBox
import sys

from pprint import pprint
from lib.treemodel import TreeModel
from lib.xmllib import compareXML
from lib.barlib import menubar
from lib.treeview import TreeView
from lib.CONSTANTS import NONE

class diffML(QMainWindow):
    def __init__(self):
        super().__init__()

        frame = QWidget()
        self.setCentralWidget(frame)
        self.grid = QGridLayout()
        frame.setLayout(self.grid)

        menubar(self) 

        self.XMLViewOne = TreeView()
        self.grid.addWidget(self.XMLViewOne,0,0)

        self.XMLViewTwo = TreeView()
        self.grid.addWidget(self.XMLViewTwo,0,1)
        self.XMLViewTwo.hide()
        self.hasViewTwo = False

        self.XMLModelOne = False
        self.XMLModelTwo = False

        self.colorState = NONE

        self.show()
    
    def open(self):
        path = QFileDialog.getOpenFileName(self)
        if path[0]:
            model = TreeModel(path[0])
            if self.hasViewTwo:
                choices = ("1","2","Both")
                choice = QInputDialog.getItem(self, 'Open', 'Workspace:', choices)
                if choice[0] == "1":
                    self.XMLModelOne = model
                    self.XMLViewOne.setModel(model)
                    self.XMLModelOne.setColor(self.colorState)

                elif choice[0] == "2":
                    self.XMLModelTwo = model
                    self.XMLViewTwo.setModel(model)
                    self.XMLModelTwo.setColor(self.colorState)

                else:
                    self.XMLModelOne = model
                    self.XMLViewOne.setModel(model)
                    self.XMLModelOne.setColor(self.colorState)
                    
                    model = TreeModel(path[0])
                    self.XMLModelTwo = model
                    self.XMLViewTwo.setModel(model)
                    self.XMLModelTwo.setColor(self.colorState)

            else:
                self.XMLModelOne = model
                self.XMLViewOne.setModel(model)
                self.XMLModelOne.setColor(self.colorState)

    def toggleViewTwo(self):
        if  self.hasViewTwo:
            self.hasViewTwo = False
            self.XMLViewTwo.hide()
        else:
            self.hasViewTwo = True
            self.XMLViewTwo.show()
    
    def setColor(self, color):
        self.colorState = color
        if self.XMLModelOne:
            self.XMLModelOne.setColor(color)
            self.XMLViewOne.setFocus()
        if self.XMLModelTwo:
            self.XMLModelTwo.setColor(color)
            self.XMLViewTwo.setNoneColor()
    
    def compare(self):
        choices = ("Tag","Text","Attribute")
        choice = QInputDialog.getItem(self, 'Compare Selected Elements', 'What to match with?', choices)

        selectedOne = self.XMLViewOne.selectedIndexes()

        if self.hasViewTwo:
            selectedTwo = self.XMLViewTwo.selectedIndexes()
            result = compareXML(choice[0],
                                self.XMLModelOne.getXMLTree(),
                                selectedOne,
                                self.XMLModelTwo.getXMLTree(),
                                selectedTwo)
            QMessageBox.question(self,'Result:','There were ' + str(len(result)) + ' differences.', QMessageBox.Save | QMessageBox.Ok)
            pprint(result)

    def save(self):
        if self.XMLModelOne:
            self.XMLModelOne.save()
        if self.XMLModelTwo:
            self.XMLModelTwo.save()
        
    def saveAs(self):
        path = QFileDialog.getSaveFileName(self)
        if path[0] != '':
            if self.XMLModelOne:
                self.XMLModelOne.save(path[0])
            if self.XMLModelTwo:
                self.XMLModelTwo.save(path[0])

app = QApplication(sys.argv)

masterView = diffML()

sys.exit(app.exec_())
